name: Deploy to Vercel & Render

on:
  workflow_run:
    workflows: [Test & Code Quality]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Check if quality gates passed before deploying
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  check-quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.gate.outputs.approved }}
    steps:
      - name: Check workflow status
        id: gate
        continue-on-error: true
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "approved=false" >> $GITHUB_OUTPUT
              echo "âŒ Quality checks failed - blocking deployment"
              exit 1
            else
              echo "approved=true" >> $GITHUB_OUTPUT
              echo "âœ… Quality gates approved - proceeding with deployment"
            fi
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Only workflow_run triggers deployments"
          fi
      
      - name: Fail if not approved
        if: steps.gate.outputs.approved != 'true'
        run: exit 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy frontend to Vercel
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-vercel:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: check-quality-gate
    if: needs.check-quality-gate.outputs.approved == 'true'
    environment:
      name: production-frontend
      url: https://gpu-connect.vercel.app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify quality gate passed
        run: |
          if [ "${{ needs.check-quality-gate.outputs.approved }}" != "true" ]; then
            echo "âŒ Quality gate not approved - refusing to deploy"
            exit 1
          fi
          echo "âœ… Quality gate verified - proceeding with Vercel deployment"

      - name: Deploy to Vercel
        uses: vercel/action@main
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
        env:
          VERCEL_GITHUB_DEPLOYMENT: true
          VERCEL_GITHUB_COMMENT: true

      - name: Log deployment
        run: |
          echo "âœ… Frontend deployed to Vercel"
          echo "URL: https://gpu-connect.vercel.app"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy backend to Render
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-render:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: check-quality-gate
    if: needs.check-quality-gate.outputs.approved == 'true'
    environment:
      name: production-backend
      url: https://gpu-connect-api.onrender.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify quality gate passed
        run: |
          if [ "${{ needs.check-quality-gate.outputs.approved }}" != "true" ]; then
            echo "âŒ Quality gate not approved - refusing to deploy"
            exit 1
          fi
          echo "âœ… Quality gate verified - proceeding with Render deployment"

      - name: Deploy to Render via webhook
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            ${{ secrets.RENDER_DEPLOY_WEBHOOK }} \
            -d '{
              "commit": "${{ github.sha }}",
              "ref": "${{ github.ref }}",
              "message": "Deployment triggered by GitHub Actions - quality gates passed"
            }' || echo "âš ï¸  Render webhook failed (may already be deploying)"

      - name: Log deployment
        run: |
          echo "âœ… Backend deployment triggered on Render"
          echo "URL: https://gpu-connect-api.onrender.com"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Notify on failed quality gate
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-blocked:
    name: Notify Blocked Deployment
    runs-on: ubuntu-latest
    needs: check-quality-gate
    if: needs.check-quality-gate.outputs.approved != 'true'
    steps:
      - name: Create comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš« **Deployment Blocked**\n\nQuality gates did not pass. Check the test results and code quality reports before retrying.'
            });

      - name: Log blocked deployment
        run: |
          echo "âŒ Deployment blocked due to failed quality checks"
          echo "Please fix issues and retry"
